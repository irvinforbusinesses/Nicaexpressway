<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Seguimiento y Cotización</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --color-bg:#E8F0F5;
  --color-accent:#2F528F;
  --lapis:#1F3A66; /* lapis lazuli para resaltados */
  --text:#1A1A1A;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Inter",sans-serif;
  background:var(--color-bg);
  color:var(--text);
  padding:1rem;
  max-width:500px;
  margin:auto;
  padding-bottom:120px;
}
header{text-align:center;margin-bottom:1.5rem}
h1{font-family:'Poppins',sans-serif;font-size:1.8rem;color:var(--color-accent)}
nav{display:flex;justify-content:center;gap:.5rem;margin-top:1rem}
nav button{flex:1;background:var(--color-accent);color:#fff;border:none;padding:.75rem;font-weight:700;border-radius:8px;cursor:pointer}
nav button.inactive{background:#a0b6e0}
nav button#btnSeguimiento.active-highlight { background: var(--lapis); }

/* sections */
section{
  background:#FFFFFF;
  padding:1.5rem;
  border-radius:12px;
  margin-top:1rem;
  display:none;
  opacity:0;
  transform:translateY(12px);
  animation: fadeIn 0.36s forwards;
  box-shadow:0 6px 14px rgba(0,0,0,0.08);
}
section.active{display:block}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

/* Inicio linktree - small tweaks */
#inicio{text-align:center;padding:3rem 4rem}
#inicio img{width:100px;height:100px;border-radius:50%;display:block;margin:0 auto 1rem;object-fit:cover;box-shadow:0 6px 18px rgba(47,82,143,0.18)}
.linktree-buttons{display:flex;flex-direction:column;gap:1rem}
.link-btn{display:flex;justify-content:center;align-items:center;background:var(--color-accent);color:#fff;text-decoration:none;padding:.96rem 6rem;border-radius:999px;font-weight:700;font-size:1rem;max-width:220px;margin:0.3rem auto;box-shadow:0 2px 6px rgba(0,0,0,0.12);transition:transform .12s}
.link-btn:hover{transform:translateY(-3px);background:#1f3a66}

/* Form basics */
label{display:block;margin:1rem 0 .5rem;font-weight:600}
select,input,textarea{width:100%;padding:.75rem;border-radius:8px;border:1px solid #ccc;font-size:1rem}
input::placeholder { color:#9aa3ad; }
textarea { resize: vertical; }
button.calc-btn{margin-top:1rem;background:var(--color-accent);color:white;border:none;padding:.75rem;font-size:1rem;border-radius:8px;width:100%;font-weight:bold;cursor:pointer}
.resultado{margin-top:1rem;font-size:1.05rem;font-weight:600}
footer { color: #888; text-align: center; padding: 0.8rem 0.5rem; font-size: 0.8rem; margin-top: 1.5rem; }

/* Seguimiento form layout */
.row{display:flex;gap:.5rem}
.col{flex:1}

/* small flag+phone */
.phone-row{display:flex;gap:.5rem}
.phone-row select{width:35%;padding:.6rem;border-radius:8px}
.phone-row input{flex:1}

/* resultado package box */
.package-box{margin-top:1rem;padding:1rem;border-radius:10px;background:#fbfcfe;border:1px solid #eef3f8}
.package-title{font-weight:700;margin-bottom:.5rem;color:var(--color-accent)}
.details-row{display:flex;justify-content:space-between;gap:.5rem;margin-top:.4rem;font-size:.95rem}
.details-row div{flex:1;text-align:left}

/* timeline */
.timeline{position:relative;padding-left:24px;border-left:2px solid rgba(47,82,143,0.08);margin-bottom:.5rem}
.timeline-item{position:relative;padding:8px 12px;margin-bottom:.5rem}
.timeline-item::before{content:"";position:absolute;left:-11px;top:8px;width:12px;height:12px;border-radius:50%;background:#fff;border:3px solid var(--color-accent)}
.timeline-item .state{font-weight:700}
.timeline-item .subtext{font-size:.9rem;color:#555;margin-top:.25rem}
.timeline-item .fecha{font-size:.85rem;color:#666;margin-top:.25rem}

/* blinking mini section for listo_recoger */
.blink {
  animation: blinkAnim 0.9s step-start 0s infinite;
  box-shadow:0 0 0 4px rgba(47,82,143,0.06) inset;
  border-radius:8px;
}
@keyframes blinkAnim {
  50% { opacity: 0.25; transform: translateY(-1px); }
}

/* confetti container */
#confettiWrap{pointer-events:none;position:fixed;left:0;top:0;width:100%;height:100%;overflow:hidden;z-index:2000}

/* small utility */
.small-muted{font-size:.9rem;color:#666;margin-top:.25rem}
.center{text-align:center}

/* responsive tweaks */
@media (max-width:420px){ .link-btn{max-width:100%} .phone-row select{width:40%} }

/* ======= SOLICITAR tweaks (button hidden in nav only) ======= */
#solicitar .resultado-solicitar { margin-top:12px; font-weight:700; }
#reciboSolicitar { margin-top:10px; padding:12px; border-radius:10px; background:#fbfcfe; border:1px solid #eef3f8; display:none; text-align:left; }
#reciboSolicitar .line { margin:6px 0; display:flex; justify-content:space-between; align-items:center; }
#reciboSolicitar .estimado { text-align:center; margin-top:8px; font-weight:600; color:#444; }

/* waiting overlay / popup (solicitando...) */
#waitingPop { position: fixed; left:50%; top:50%; transform: translate(-50%,-50%) scale(.98); background: #fff; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.12); z-index:3000; width:88%; max-width:360px; display:none; opacity:0; transition: opacity .28s ease, transform .28s ease; text-align:center; }
#waitingPop.show { display:block; opacity:1; transform: translate(-50%,-50%) scale(1); }
.waiting-circle { width:76px; height:76px; border-radius:999px; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; background: rgba(47,82,143,0.06); }
.spinner { width:36px; height:36px; border-radius:50%; border:4px solid rgba(47,82,143,0.18); border-top-color: var(--color-accent); animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* confirm pop (check) */
#confirmPop { position: fixed; left:50%; top:50%; transform: translate(-50%,-50%) scale(.98); background: #fff; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.12); z-index:3000; width:88%; max-width:360px; display:none; opacity:0; transition: opacity .28s ease, transform .28s ease; text-align:center; }
#confirmPop.show { display:block; opacity:1; transform: translate(-50%,-50%) scale(1); }
.check-icon { width:72px;height:72px;border-radius:999px;margin:0 auto 0.6rem;display:flex;align-items:center;justify-content:center;background:rgba(47,82,143,0.08); }
.check-icon svg { display:block; }

/* waiting overlay small used by lightbox when fetching historial */
.lightbox-loading { padding:10px 14px; border-radius:10px; background:#fff; box-shadow:0 8px 24px rgba(0,0,0,0.12); display:flex;align-items:center;gap:12px; justify-content:center; }

/* Multi-result cards (match operator look & feel) */
.multi-list { margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem; }
.multi-card {
  background: #fbfcfe;
  border: 1px solid #eef3f8;
  padding: 0.8rem;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition: transform .12s, box-shadow .12s;
}
.multi-card:hover { transform: translateY(-3px); box-shadow:0 8px 18px rgba(31,58,102,0.06); }
.multi-card .left { display:flex; flex-direction:column; gap:6px; }
.multi-card .title { font-weight:700; color:var(--color-accent); }
.multi-card .subtitle { font-size:0.9rem; color:#666; }
.multi-card .right { font-weight:700; color:var(--color-accent); font-size:0.95rem; }

/* Lightbox modal for package detail */
#packageLightboxOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 4000;
  padding: 1rem;
}
#packageLightbox {
  width: 100%;
  max-width: 520px;
  background: #fff;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 12px 36px rgba(0,0,0,0.16);
  max-height: 86vh;
  overflow-y: auto;
  position: relative;
}
#packageLightbox .close-btn {
  position: absolute;
  top: 10px; right: 10px;
  background: #fff; border: 1px solid #e6e9ef;
  width: 38px; height:38px; border-radius:50%; font-size:18px; cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
#packageLightbox h3 { margin-bottom: 6px; color: var(--color-accent); font-family: 'Poppins', sans-serif; }
.package-info-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
.package-info-row .info { flex:1; background:#fbfcfe;padding:10px;border-radius:8px;border:1px solid #eef3f8; }

/* WhatsApp CTA for cotizar */
#cotizarCtaWrap { display:flex; justify-content:center; margin-top:12px; }
.wa-cta {
  display:inline-flex; align-items:center; justify-content:center;
  background: var(--color-accent); color:#fff; padding:12px 18px; border-radius:999px;
  text-decoration:none; font-weight:700; font-size:1rem; box-shadow:0 6px 18px rgba(31,58,102,0.14); opacity:0; transform: translateY(6px);
  transition: opacity .4s ease, transform .4s ease;
}
.wa-cta.visible { opacity:1; transform: translateY(0); }
@keyframes floatLoop { 0%{ transform: translateY(0);} 50%{ transform: translateY(-8px);} 100%{ transform: translateY(0);} }
.wa-cta.float { animation: floatLoop 3s ease-in-out infinite; }

/* Subtitle style (footer-like, centered, with line below) */
.subtitle-footer {
  text-align:center;
  color:#888;
  font-size:0.85rem;
  margin:8px 0 12px;
  font-family: 'Poppins', sans-serif;
  font-weight:600;
  position:relative;
  padding-bottom:10px;
}
.subtitle-footer::after{
  content:"";
  display:block;
  height:1px;
  width:70%;
  margin:8px auto 0;
  background:#e6e9ef;
  border-radius:2px;
}

/* ensure no generic browser look for modal buttons */
.modal-close-btn { margin-top:12px; background:#888;color:#fff;border:none;padding:.6rem .8rem;border-radius:8px; cursor:pointer; }

/* small utilities */
.hidden{ display:none !important; }

</style>
</head>
<body>

<header>
  <h1>Nica Expressway</h1>
  <nav>
    <button id="btnInicio">Inicio</button>
    <button id="btnCotizar" class="inactive">Cotizar</button>
    <button id="btnSolicitar" class="inactive" style="display:none;" title="Oculto por solicitud del cliente (no borrado)">Solicitar</button>
    <button id="btnSeguimiento" class="inactive">Seguimiento</button>
  </nav>
</header>

<!-- INICIO -->
<section id="inicio" class="active">
  <img id="logoMain" src="https://github.com/Irvyandl/VirtualAssistance/blob/main/assets/visuals/logo.jpg?raw=true" alt="Logo Nica Expressway">
  <p style="margin-bottom:1.25rem;">Conéctate con nosotros en nuestras redes y mantente al día con tus envíos</p>
  <div class="linktree-buttons">
    <a class="link-btn" href="https://www.instagram.com/nicaexpressway/" target="_blank">Instagram</a>
    <a class="link-btn" href="https://www.facebook.com/profile.php?id=61577870368716" target="_blank">Facebook</a>
    <a class="link-btn" href="https://wa.me/17869133662" target="_blank">WhatsApp</a>
  </div>
</section>

<!-- COTIZAR -->
<section id="cotizar">
  <h2>Calculadora de Envío</h2>

  <div style="max-width:420px;margin:0 auto;">
    <label for="tipoEnvio">Tipo de envío:</label>
    <select id="tipoEnvio">
      <option value="aereo">Aéreo</option>
      <option value="maritimo">Marítimo</option>
    </select>

    <label for="peso">Peso aproximado (libras):</label>
    <input type="number" id="peso" placeholder="Ej: 5">

    <button class="calc-btn" id="btnCalcularMain">Calcular</button>

    <div id="resultado" class="package-box" style="text-align:center;margin-top:12px;display:none"></div>
  </div>

  <!-- CTA: aparecerá 3s después del cálculo exitoso -->
  <div id="cotizarCtaWrap" style="display:flex;justify-content:center;">
    <!-- inserted by JS -->
  </div>
</section>

<!-- SOLICITAR (se deja la sección intacta pero el botón nav está oculto) -->
<section id="solicitar">
  <h2>Solicita tu pedido</h2>

  <label for="nombreSolicitar">Nombre</label>
  <input type="text" id="nombreSolicitar" placeholder="Ej: Lester Gamez">

  <label for="telCodeSolicitar">Teléfono</label>
  <div class="phone-row">
    <select id="telCodeSolicitar">
      <option value="+505">Nicaragua (+505)</option>
      <option value="+1">USA (+1)</option>
    </select>
    <input type="tel" id="telefonoSolicitar" placeholder="Ej: 12345678" inputmode="numeric" pattern="[0-9]{8,10}">
  </div>

  <label for="plataformaSolicitar">Plataforma / Agencia</label>
  <input type="text" id="plataformaSolicitar" placeholder="Ej: Shein">

  <label for="descripcionSolicitar">Descripción (opcional)</label>
  <textarea id="descripcionSolicitar" rows="2" placeholder="Ej: Ropa, perfumes, etc"></textarea>

  <label for="tipoEnvioSolicitar">Tipo de envío</label>
  <select id="tipoEnvioSolicitar">
    <option value="aereo">Aéreo</option>
    <option value="maritimo">Marítimo</option>
  </select>

  <label for="pesoSolicitar">Peso aproximado (libras)</label>
  <input type="number" id="pesoSolicitar" placeholder="Ej: 2.0" step="0.1" min="0">

  <button id="btnCalcularSolicitar" class="calc-btn">Solicitar</button>
  <button id="btnConfirmarSolicitar" class="calc-btn" style="display:none;background:#1f3a66;">Confirmar solicitud</button>

  <!-- Recibo -->
  <div id="reciboSolicitar" aria-live="polite">
    <div class="line"><div>Precio por libra de envío</div><div id="rcPrecioLibra">-</div></div>
    <div class="line"><div>Libras totales</div><div id="rcLibras">-</div></div>
    <div class="line"><div><strong>Total</strong></div><div id="rcTotal"><strong>-</strong></div></div>
    <div class="estimado" id="rcEstimado"></div>
  </div>

</section>

<!-- SEGUIMIENTO (actualizado y reordenado según pedido) -->
<section id="seguimiento">
  <h2 id="seguimientoTitle">Manejo de pedidos</h2>

  <!-- subtitulo estilo footer centrado -->
  <div class="subtitle-footer">Busca por cliente (nombre o teléfono)</div>

  <!-- Primero: campos Nombre + Teléfono -->
  <label for="nombreBuscar">Nombre del cliente</label>
  <input type="text" id="nombreBuscar" placeholder="Ej: Lester Gamez">

  <label for="telefonoBuscar">Teléfono (8-10 dígitos)</label>
  <div class="phone-row" style="margin-bottom:0.5rem;">
    <select id="telCodeBuscar">
      <option value="(505)">Nicaragua (505)</option>
      <option value="(1)">USA (1)</option>
      <option value="(52)">Mexico (52)</option>
    </select>
    <input type="tel" id="telefonoBuscar" placeholder="Ej: 12345678" inputmode="numeric" pattern="[0-9]{8,10}">
  </div>

  <!-- subtitulo 2 con linea -->
  <div class="subtitle-footer" style="margin-top:8px;">O busca un paquete en específico con el código de seguimiento</div>

  <!-- ahora el campo Código -->
  <label for="codigo">Código de seguimiento</label>
  <input type="text" id="codigo" placeholder="Ej: ABC123">

  <div class="row" style="gap:.6rem;margin-top:.6rem;">
    <div class="col"><button id="btnBuscar" class="calc-btn">Buscar</button></div>
    <div class="col"><button id="btnLimpiar" class="calc-btn" style="background:#888;">Limpiar</button></div>
  </div>

  <!-- Loader / overlay pequeño -->
  <div id="searchOverlay" style="display:none;margin-top:1rem;padding:.9rem;border-radius:8px;background:#f3f7fb;text-align:center;">
    <strong>Buscando tu paquete, espera...</strong>
  </div>

  <!-- Multi-results (cuando la búsqueda por cliente devuelve varios) -->
  <div id="multiResults" class="multi-list" style="display:none;"></div>

  <!-- Resultado individual (timeline + detalles) -->
  <div id="resultContainer" class="package-box" style="display:none;">
    <!-- timeline -->
    <div id="timeline" class="timeline"></div>

    <!-- datos principales -->
    <div id="packageDetails" class="details-row" style="margin-top:1rem">
      <div>
        <div class="small-muted">Tipo de envío</div>
        <div id="detalleTipo">-</div>
      </div>
      <div>
        <div class="small-muted">Peso (lbs)</div>
        <div id="detallePeso">-</div>
      </div>
      <div>
        <div class="small-muted">Tarifa / lb (USD)</div>
        <div id="detalleTarifa">USD-</div>
      </div>
    </div>

    <div style="margin-top:.8rem" id="detalleTotal"><strong>Total:</strong> -</div>
  </div>

  <div id="noResult" class="small-muted center" style="margin-top:1rem; display:none;">Aquí se mostrará el estado del envío.</div>
</section>

<!-- Lightbox overlay for package detail -->
<div id="packageLightboxOverlay" aria-hidden="true">
  <div id="packageLightbox" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
    <button class="close-btn" id="lbClose" aria-label="Cerrar ventana">×</button>
    <h3 id="lbTitle">Pedido</h3>

    <!-- header info: "Pedido hecho el {fecha1}" + tipo/peso/tarifa -->
    <div id="lbHeader" style="margin-top:6px;">
      <div id="lbWhen" style="font-weight:700;color:var(--color-accent);">Pedido hecho el -</div>
      <div class="package-info-row" style="margin-top:8px;">
        <div class="info"><div class="small-muted">Tipo de envío</div><div id="lbTipo">-</div></div>
        <div class="info"><div class="small-muted">Peso aproximado</div><div id="lbPeso">-</div></div>
        <div class="info"><div class="small-muted">Tarifa / lb</div><div id="lbTarifa">-</div></div>
      </div>
    </div>

    <!-- small loader while fetching historial -->
    <div id="lbLoading" style="display:none;margin-top:12px;justify-content:center;">
      <div class="lightbox-loading"><div class="spinner" style="width:28px;height:28px;border-width:3px;"></div><div style="font-weight:700;color:var(--color-accent);margin-left:8px;">Cargando historial...</div></div>
    </div>

    <!-- timeline container -->
    <div id="lbTimeline" class="timeline" style="margin-top:12px;"></div>

    <!-- close CTA only -->
    <div style="text-align:center;margin-top:10px;">
      <button id="lbCloseBtn" class="modal-close-btn">Cerrar</button>
    </div>
  </div>
</div>

<!-- waiting popup (solicitando) -->
<div id="waitingPop" role="status" aria-live="polite">
  <div class="waiting-circle" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
  </div>
  <div style="font-weight:700;color:var(--color-accent);margin-bottom:6px;">Solicitando tu pedido</div>
  <div style="color:#444;margin-bottom:8px;">Estamos procesando tu solicitud, por favor espera...</div>
  <div class="error" id="waitingError" style="display:none;"></div>
</div>

<!-- confirm popup -->
<div id="confirmPop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="check-icon" aria-hidden="true">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="none"/>
      <path d="M9 12.5l2 2 4-4" stroke="#2F528F" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    </svg>
  </div>
  <h3 style="color:var(--color-accent);margin-bottom:6px;">Tu solicitud ha sido enviada</h3>
  <p style="color:#444;margin-bottom:10px;">Te contactaremos por WhatsApp para confirmar el estado de tu solicitud en los próximos minutos.</p>
  <button id="btnCerrarConfirm" class="calc-btn" style="background:var(--color-accent);">Cerrar</button>
</div>

<!-- confetti wrapper -->
<div id="confettiWrap" aria-hidden="true"></div>

<footer>
  <p>&copy; 2025. Irvin Prado. Ascende Superius - Seek Higher Things</p>
</footer>

<script>
/* CONFIG */
const API_BASE = 'https://nicaexpressway.onrender.com'; // <- adapta si tu deploy usa otra URL

/* UI refs */
const btnInicio = document.getElementById('btnInicio');
const btnCotizar = document.getElementById('btnCotizar');
const btnSolicitar = document.getElementById('btnSolicitar'); // oculto en nav
const btnSeguimiento = document.getElementById('btnSeguimiento');

const secciones = {
  inicio: document.getElementById('inicio'),
  cotizar: document.getElementById('cotizar'),
  solicitar: document.getElementById('solicitar'),
  seguimiento: document.getElementById('seguimiento')
};

/* Navigation with seguimiento highlight using lapis color */
function resetNavStyles(){
  [btnInicio,btnCotizar,btnSolicitar,btnSeguimiento].forEach(b=>{
    if(!b) return;
    b.classList.remove('active-highlight');
    // reset inline background to default if needed
    b.style.background = '';
  });
}
function mostrarSeccion(nombre){
  for(let s in secciones) {
    if(secciones[s]) secciones[s].classList.remove('active');
  }
  if(secciones[nombre]) secciones[nombre].classList.add('active');

  [btnInicio,btnCotizar,btnSolicitar,btnSeguimiento].forEach(b=>{ if(b) b.classList.add('inactive'); });
  if(nombre==='inicio' && btnInicio) { btnInicio.classList.remove('inactive'); }
  if(nombre==='cotizar' && btnCotizar) { btnCotizar.classList.remove('inactive'); }
  if(nombre==='solicitar' && btnSolicitar) { btnSolicitar.classList.remove('inactive'); }
  if(nombre==='seguimiento' && btnSeguimiento) {
    btnSeguimiento.classList.remove('inactive');
    // highlight seguimiento with lapis
    btnSeguimiento.classList.add('active-highlight');
  } else {
    if(btnSeguimiento) btnSeguimiento.classList.remove('active-highlight');
  }
}
if(btnInicio) btnInicio.addEventListener('click',()=>mostrarSeccion('inicio'));
if(btnCotizar) btnCotizar.addEventListener('click',()=>mostrarSeccion('cotizar'));
if(btnSolicitar) btnSolicitar.addEventListener('click',()=>mostrarSeccion('solicitar'));
if(btnSeguimiento) btnSeguimiento.addEventListener('click',()=>mostrarSeccion('seguimiento'));

/* CALCULAR in Cotizar: compute, show boxed result centered, reset form, then show WA CTA after 3s */
const btnCalcularMain = document.getElementById('btnCalcularMain');
const resultadoDiv = document.getElementById('resultado');
const cotizarCtaWrap = document.getElementById('cotizarCtaWrap');

function crearWaButton(){
  const waHref = 'https://wa.me/17869133662?text=' + encodeURIComponent('Hola, Nica express, me gustaria hacer un pedido.');
  const a = document.createElement('a');
  a.className = 'wa-cta';
  a.href = waHref;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.innerText = 'Realiza tu pedido ahora';
  return a;
}
let waBtnTimeout = null;

function resetCotizarForm(){
  const tipoEl = document.getElementById('tipoEnvio');
  const pesoEl = document.getElementById('peso');
  if(tipoEl) tipoEl.value = 'aereo';
  if(pesoEl) pesoEl.value = '';
}

btnCalcularMain.addEventListener('click', (e)=>{
  e.preventDefault();
  const tipo = document.getElementById('tipoEnvio').value;
  const peso = parseFloat(document.getElementById('peso').value);
  if(isNaN(peso)||peso<=0){ alert('Por favor, ingresa un peso válido.'); return; }
  let precio=0,dias=0;
  if(tipo==='aereo'){ precio = peso*7.50; dias=7; } else { precio = peso*3.00; dias=15; }

  // show boxed result centered
  resultadoDiv.style.display = 'block';
  resultadoDiv.innerHTML = `<div style="font-weight:700">Precio estimado: $${precio.toFixed(2)} USD</div><div style="margin-top:6px">Llegada estimada: ${dias} días</div>`;

  // reset form (as requested)
  resetCotizarForm();

  // remove any previous wa CTA
  cotizarCtaWrap.innerHTML = '';

  // show WA CTA after 3s with fade-in + float animation
  if(waBtnTimeout) clearTimeout(waBtnTimeout);
  waBtnTimeout = setTimeout(()=>{
    const btn = crearWaButton();
    cotizarCtaWrap.appendChild(btn);
    // force a small delay to allow CSS transition
    setTimeout(()=> { btn.classList.add('visible'); btn.classList.add('float'); }, 50);
  }, 3000);
});

/* ================================
   SEGUIMIENTO: búsqueda condicional
   ================================ */
const btnBuscar = document.getElementById('btnBuscar');
const btnLimpiar = document.getElementById('btnLimpiar');
const overlay = document.getElementById('searchOverlay');
const resultContainer = document.getElementById('resultContainer');
const noResult = document.getElementById('noResult');
const timelineEl = document.getElementById('timeline');
const detalleTipo = document.getElementById('detalleTipo');
const detallePeso = document.getElementById('detallePeso');
const detalleTarifa = document.getElementById('detalleTarifa');
const detalleTotal = document.getElementById('detalleTotal');
const multiResults = document.getElementById('multiResults');

if(btnBuscar) btnBuscar.addEventListener('click', onBuscar);
if(btnLimpiar) btnLimpiar.addEventListener('click', onLimpiar);

function onLimpiar(){
  const c = document.getElementById('codigo');
  const n = document.getElementById('nombreBuscar');
  const t = document.getElementById('telefonoBuscar');
  const cc = document.getElementById('telCodeBuscar');
  if(c) c.value='';
  if(n) n.value='';
  if(t) t.value='';
  if(cc) cc.value='(505)';
  hideResult();
  multiResults.style.display = 'none';
  multiResults.innerHTML = '';
}

/* gather params */
function gatherSearchParams(){
  const codigo = (document.getElementById('codigo').value||'').trim() || null;
  const nombre = (document.getElementById('nombreBuscar').value||'').trim() || null;
  const country = document.getElementById('telCodeBuscar').value;
  const telefonoDigits = (document.getElementById('telefonoBuscar').value||'').trim() || null;
  const telefono = telefonoDigits ? `${country}${telefonoDigits}` : null;
  return { codigo, nombre, telefono };
}

/* validation: require at least one, and disallow mixing codigo with (nombre or telefono) */
function validateSearch(params){
  if(!(params.codigo || params.nombre || params.telefono)){
    alert('Ingresa al menos el código, o el nombre, o el teléfono para buscar.');
    return false;
  }
  if(params.codigo && (params.nombre || params.telefono)){
    alert('Por favor busca por **código** O por **nombre/telefono**. No mezcles ambos.');
    return false;
  }
  return true;
}

/* main handler */
async function onBuscar(){
  const params = gatherSearchParams();
  if(!validateSearch(params)) return;

  // show overlay/loader
  if(overlay) overlay.style.display = 'block';
  hideResult();
  multiResults.style.display = 'none';
  multiResults.innerHTML = '';

  try {
    const res = await fetchPackageFromAPI(params);

    if(!res){
      if(overlay) overlay.style.display = 'none';
      if(noResult){ noResult.style.display = 'block'; noResult.textContent = 'No se encontró paquete con los criterios introducidos.'; }
      return;
    }

    // if returns paquetes array -> multiple results
    if(res.paquetes && Array.isArray(res.paquetes)){
      renderMultiplePackages(res.paquetes);
      if(overlay) overlay.style.display = 'none';
      return;
    }

    // else single paquete with historial
    renderPackageResult(res);
    if(overlay) overlay.style.display = 'none';
  } catch (err) {
    console.error('Error búsqueda:', err);
    if(overlay) overlay.style.display = 'none';
    if(noResult){ noResult.style.display = 'block'; noResult.textContent = 'Ocurrió un error buscando el paquete. Revisa la consola.'; }
  }
}

/* fetch unified: returns either { paquete, historial } for codigo search OR { paquetes: [...] } for name/phone search */
async function fetchPackageFromAPI({ codigo, nombre, telefono }){
  codigo = codigo ? String(codigo).trim() : null;
  nombre = nombre ? String(nombre).trim() : null;
  telefono = telefono ? String(telefono).trim() : null;

  // 1) if codigo => GET /paquetes?codigo=...
  if (codigo) {
    const resP = await fetch(`${API_BASE}/paquetes?codigo=${encodeURIComponent(codigo)}`);
    if (!resP.ok) { console.warn('paquetes fetch fallo', resP.status); return null; }
    const arr = await resP.json();
    if (!Array.isArray(arr) || arr.length === 0) return null;
    const paquete = arr[0];

    // do NOT fetch historial here (Option B) — we'll fetch in lightbox when user opens it.
    // But to keep current single-package display showing timeline, try to fetch historial now for UX:
    let historial = null;
    try {
      const resH = await fetch(`${API_BASE}/historial?codigo=${encodeURIComponent(paquete.codigo_seguimiento)}`);
      if (resH.ok) historial = await resH.json();
    } catch(err){ console.warn('historial fetch failed', err); historial = null; }

    return { paquete, historial };
  }

  // 2) if name/phone => POST /paquetes/search (may return multiple)
  if (nombre || telefono) {
    const res = await fetch(`${API_BASE}/paquetes/search`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre, telefono })
    });
    if (!res.ok) { console.warn('search endpoint fallo', res.status); return null; }
    const arr = await res.json();
    if (!Array.isArray(arr) || arr.length === 0) return null;

    // return the array without fetching historial for each (Option B)
    return { paquetes: arr };
  }

  return null;
}

/* render when a single paquete with historial (or possibly historial null) */
function renderPackageResult({ paquete, historial }){
  // clear multiResults
  multiResults.style.display = 'none';
  multiResults.innerHTML = '';

  // show result container
  timelineEl.innerHTML = '';
  detalleTipo.textContent = 'Datos aún no disponibles';
  detallePeso.textContent = 'Datos aún no disponibles';
  detalleTarifa.textContent = 'Datos aún no disponibles';
  detalleTotal.innerHTML = '<strong>Total:</strong> Datos aún no disponibles';
  if(noResult) noResult.style.display='none';
  if(resultContainer) resultContainer.style.display='block';

  // Map tipo_envio_id -> texto
  const tipoMap = { 1: 'Aéreo', 2: 'Marítimo' };
  detalleTipo.textContent = tipoMap[paquete?.tipo_envio_id] ?? (paquete?.tipo || 'Datos aún no disponibles');

  detallePeso.textContent = paquete?.peso_libras  ?? 'Datos aún no disponibles';
  detalleTarifa.textContent = paquete?.tarifa_usd ?? 'Datos aún no disponibles';

  // Total
  if (paquete?.peso_libras != null && paquete?.tarifa_usd != null){
    const total = Number(paquete.peso_libras) * Number(paquete.tarifa_usd);
    detalleTotal.innerHTML = `<strong>Total:</strong> $${isFinite(total) ? total.toFixed(2) : '0.00'} USD`;
  }

  // Timeline: if historial present render now, else show 'Historial no disponible'
  timelineEl.innerHTML = '';
  if (!historial) {
    timelineEl.innerHTML = '<div class="small-muted">Historial no disponible (abre el detalle para cargar historial completo).</div>';
  } else {
    buildTimelineFromHistorialElement(historial, timelineEl);
  }
}

/* render multiple packages (list) */
function renderMultiplePackages(paquetes){
  // hide single result
  if(resultContainer) resultContainer.style.display = 'none';
  if(noResult) noResult.style.display='none';

  multiResults.innerHTML = '';
  paquetes.forEach(p => {
    const card = document.createElement('div');
    card.className = 'multi-card';
    // preview date: prefer paquete.fecha_estado if present, else 'No disponible'
    const previewDate = p.fecha_estado ? formatDate(p.fecha_estado) : 'No disponible';
    const left = document.createElement('div');
    left.className = 'left';
    left.innerHTML = `<div class="title">Pedido del ${previewDate}</div><div class="subtitle">${escapeHtml(p.nombre_cliente ?? p.nombre ?? '-')}</div>`;
    const right = document.createElement('div');
    right.className = 'right';
    const tipoMap = { 1: 'Aéreo', 2: 'Marítimo' };
    right.innerText = tipoMap[p.tipo_envio_id] ?? (p.tipo || '-');
    card.appendChild(left);
    card.appendChild(right);

    // store paquete data on card
    card.dataset.paquete = JSON.stringify(p);

    // click opens lightbox and fetches historial (Option B: historial fetched only when opening)
    card.addEventListener('click', async ()=>{
      const paqueteObj = JSON.parse(card.dataset.paquete);
      openPackageLightbox(paqueteObj);
    });

    multiResults.appendChild(card);
  });

  multiResults.style.display = 'flex';
}

/* Build timeline helper used by single result and lightbox after fetching historial */
function buildTimelineFromHistorialElement(historial, containerEl){
  containerEl.innerHTML = '';
  const items = [];
  for (let i=1;i<=4;i++){
    const s = historial[`estado${i}`];
    const f = historial[`fecha${i}`];
    if ((s && String(s).trim()!=='') || (f && String(f).trim()!=='')){
      items.push({ estado: s || null, fecha: f || null, index: i });
    }
  }
  if (items.length===0){
    containerEl.innerHTML = '<div class="small-muted">No hay eventos en el historial.</div>';
  } else {
    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'timeline-item';
      const label = mapStateLabel(it.estado);
      div.innerHTML = `<div class="state">${label}</div>
                       <div class="subtext">${mapStateSubtext(it.estado) || ''}</div>
                       <div class="fecha">${it.fecha ? 'El ' + formatDate(it.fecha) : ''}</div>`;
      if (it.estado && String(it.estado).toLowerCase()==='listo_recoger'){
        div.classList.add('blink');
        triggerConfetti();
      }
      containerEl.appendChild(div);
    });
  }
}

/* -----------------------------
   LIGHTBOX: open -> fetch historial
   ----------------------------- */
const packageLightboxOverlay = document.getElementById('packageLightboxOverlay');
const lbClose = document.getElementById('lbClose');
const lbCloseBtn = document.getElementById('lbCloseBtn');
const lbTitle = document.getElementById('lbTitle');
const lbWhen = document.getElementById('lbWhen');
const lbTipo = document.getElementById('lbTipo');
const lbPeso = document.getElementById('lbPeso');
const lbTarifa = document.getElementById('lbTarifa');
const lbTimeline = document.getElementById('lbTimeline');
const lbLoading = document.getElementById('lbLoading');

async function openPackageLightbox(paquete){
  if(!paquete) return;
  // show overlay
  packageLightboxOverlay.style.display = 'flex';
  packageLightboxOverlay.setAttribute('aria-hidden','false');
  // set header placeholders
  lbTitle.textContent = `Pedido ${paquete.id ? '#' + paquete.id : (paquete.codigo_seguimiento ? paquete.codigo_seguimiento : '')}`;
  // we'll fetch historial to produce "Pedido hecho el {fecha1}" — show loading UI
  lbWhen.textContent = 'Pedido hecho - (cargando...)';
  lbTipo.textContent = (paquete.tipo_envio_id ? (paquete.tipo_envio_id === 1 ? 'Aéreo' : paquete.tipo_envio_id === 2 ? 'Marítimo' : paquete.tipo) : (paquete.tipo || 'No disponible'));
  lbPeso.textContent = paquete.peso_libras ?? 'No disponible';
  lbTarifa.textContent = paquete.tarifa_usu ?? paquete.tarifa_usd ?? paquete.tarifa ?? 'No disponible';
  lbTimeline.innerHTML = '';
  lbLoading.style.display = 'flex';

  // fetch historial from API
  let historial = null;
  try {
    if(paquete.codigo_seguimiento){
      const resH = await fetch(`${API_BASE}/historial?codigo=${encodeURIComponent(paquete.codigo_seguimiento)}`);
      if(resH.ok){
        historial = await resH.json();
      } else {
        historial = null;
      }
    }
  } catch(e){
    console.warn('historial fetch failed in lightbox', e);
    historial = null;
  }

  // hide loading & populate timeline and header "pedido hecho el {fecha1}"
  lbLoading.style.display = 'none';
  if(historial && historial.fecha1){
    lbWhen.textContent = `Pedido hecho el ${formatDate(historial.fecha1)}`;
  } else if(paquete.fecha_estado){
    lbWhen.textContent = `Pedido hecho el ${formatDate(paquete.fecha_estado)}`;
  } else {
    lbWhen.textContent = 'Pedido hecho el No disponible';
  }

  if(historial){
    buildTimelineFromHistorialElement(historial, lbTimeline);
  } else {
    lbTimeline.innerHTML = '<div class="small-muted">Historial no disponible.</div>';
  }

  // focus close
  setTimeout(()=> { lbCloseBtn.focus(); }, 80);
}

function closePackageLightbox(){
  packageLightboxOverlay.style.display = 'none';
  packageLightboxOverlay.setAttribute('aria-hidden','true');
  lbTimeline.innerHTML = '';
}

if(lbClose) lbClose.addEventListener('click', closePackageLightbox);
if(lbCloseBtn) lbCloseBtn.addEventListener('click', closePackageLightbox);

/* Utils used across file (copied from your original) */
function mapStateLabel(raw){
  if(!raw) return 'Estado desconocido';
  const r = raw.toString().toLowerCase();
  switch(r){
    case 'recibido': return 'Recibido';
    case 'en_transito': return 'En tránsito';
    case 'en_aduana': return 'En aduana';
    case 'listo_recoger': return 'Listo Para Recoger';
    default: return capitalize(r.replace(/_/g,' '));
  }
}
function mapStateSubtext(raw){
  if(!raw) return '';
  const r = raw.toString().toLowerCase();
  switch(r){
    case 'recibido': return 'Paquete recibido por Nica Express Way en Estados Unidos';
    case 'en_transito': return 'Paquete en camino a Nicaragua';
    case 'en_aduana': return 'Paquete en aduanas, será recibido por la agencia pronto';
    case 'listo_recoger': return 'Paquete listo para retirar!';
    default: return '';
  }
}
function formatDate(d){
  try {
    const dt = new Date(d);
    if (isNaN(dt)) {
      if(typeof d==='string' && d.includes('-')){
        const [y,m,day] = d.split('-');
        return `${day}/${m}/${y}`;
      }
      return d;
    }
    return dt.toLocaleDateString('es-ES');
  } catch(e){
    return d;
  }
}
function capitalize(s){ return s && s.length ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
function escapeHtml(str){
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

/* CONFETTI (unchanged) */
let confettiTimeout = null;
function triggerConfettiDesktop(){ /* same as earlier, keep but simpler to avoid huge N in this response */ 
  const wrap = document.getElementById('confettiWrap');
  if (!wrap) return;
  // small burst
  const N = 80;
  const colors = ['#1f3a66','#2F528F','#79A7E4'];
  for (let i=0;i<N;i++){
    const el = document.createElement('div');
    const size = Math.floor(Math.random()*8)+6;
    el.className = 'confetti';
    el.style.position='absolute';
    el.style.left = (Math.random()*100)+'%';
    el.style.top = (-10 + Math.random()*-30) + 'px';
    el.style.width = size+'px';
    el.style.height = (size*0.6)+'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = String(0.8 + Math.random()*0.2);
    el.style.borderRadius='2px';
    el.style.zIndex = 2500;
    const destX = (Math.random()*500 - 250);
    const destY = window.innerHeight + 60;
    const duration = 2 + Math.random()*2;
    el.style.transition = `transform ${duration}s ease-out, top ${duration}s linear, opacity ${duration}s linear`;
    wrap.appendChild(el);
    requestAnimationFrame(()=>{ el.style.top = destY + 'px'; el.style.transform = `translateX(${destX}px) rotate(${Math.random()*360}deg)`; el.style.opacity = '0'; });
  }
  if (confettiTimeout) clearTimeout(confettiTimeout);
  confettiTimeout = setTimeout(()=>{ wrap.innerHTML=''; }, 4000);
}
function triggerConfettiMobile(){ triggerConfettiDesktop(); }
function triggerConfetti(){ if(window.innerWidth <= 420){ triggerConfettiMobile(); } else { triggerConfettiDesktop(); } }

/* small 'enter' submit shortcuts */
['codigo','telefonoBuscar','nombreBuscar','telefonoSolicitar','peso'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(id==='peso') { btnCalcularMain.click(); } else onBuscar(); } });
});

/* Inicial state */
(function init(){
  // start on inicio
  mostrarSeccion('inicio');
  // hide result area initially
  hideResult();
})();
function hideResult(){
  if(resultContainer) resultContainer.style.display='none';
  if(noResult) { noResult.style.display='block'; noResult.textContent = 'Aquí se mostrará el estado del envío.'; }
  if(timelineEl) timelineEl.innerHTML='';
}

/* ============================
   SOLICITAR logic (kept as before)
   ============================ */
const btnCalcularSolicitar = document.getElementById('btnCalcularSolicitar');
const btnConfirmarSolicitar = document.getElementById('btnConfirmarSolicitar');
const reciboSolicitar = document.getElementById('reciboSolicitar');
const rcPrecioLibra = document.getElementById('rcPrecioLibra');
const rcLibras = document.getElementById('rcLibras');
const rcTotal = document.getElementById('rcTotal');
const rcEstimado = document.getElementById('rcEstimado');

const waitingPop = document.getElementById('waitingPop');
const waitingError = document.getElementById('waitingError');
const confirmPop = document.getElementById('confirmPop');
const btnCerrarConfirm = document.getElementById('btnCerrarConfirm');

function calcularSolicitar(){
  const tipo = document.getElementById('tipoEnvioSolicitar').value;
  const peso = parseFloat(document.getElementById('pesoSolicitar').value);
  if (isNaN(peso) || peso <= 0) {
    alert('Por favor ingresa un peso válido.');
    return false;
  }
  let precioPorLb = 0;
  if (tipo === 'aereo') precioPorLb = 7.50;
  else precioPorLb = 3.00;

  const total = precioPorLb * peso;

  rcPrecioLibra.textContent = `$${precioPorLb.toFixed(2)} USD`;
  rcLibras.textContent = `${Number(peso).toFixed(2)} lb`;
  rcTotal.innerHTML = `<strong>$${isFinite(total) ? total.toFixed(2) : '0.00'} USD</strong>`;

  if (tipo === 'maritimo') {
    rcEstimado.textContent = 'Llegada estimada: 15 días';
  } else {
    rcEstimado.textContent = 'Llegada estimada: 7 días';
  }

  reciboSolicitar.style.display = 'block';
  btnCalcularSolicitar.style.display = 'none';
  btnConfirmarSolicitar.style.display = 'block';
  return true;
}

if (btnCalcularSolicitar) btnCalcularSolicitar.addEventListener('click', (e)=>{
  e.preventDefault();
  calcularSolicitar();
});

function validarFormularioSolicitar(){
  const nombre = (document.getElementById('nombreSolicitar').value||'').trim();
  const telCode = document.getElementById('telCodeSolicitar').value;
  const telefono = (document.getElementById('telefonoSolicitar').value||'').trim();
  const plataforma = (document.getElementById('plataformaSolicitar').value||'').trim();
  const tipo = document.getElementById('tipoEnvioSolicitar').value;
  const peso = document.getElementById('pesoSolicitar').value;

  if (!nombre) { alert('Ingresa el nombre del cliente.'); return false; }
  if (!telefono || !/^\d{8,10}$/.test(telefono)) { alert('Ingresa un teléfono válido (8-10 dígitos).'); return false; }
  if (!plataforma) { alert('Ingresa la plataforma o agencia.'); return false; }
  if (!tipo) { alert('Selecciona el tipo de envío.'); return false; }
  if (!peso || isNaN(Number(peso)) || Number(peso) <= 0) { alert('Ingresa un peso válido.'); return false; }

  return true;
}

function showWaiting(){ waitingError.style.display = 'none'; waitingError.textContent = ''; waitingPop.classList.add('show'); }
function hideWaiting(){ waitingPop.classList.remove('show'); setTimeout(()=>{ waitingError.style.display='none'; waitingError.textContent=''; }, 350); }
function showConfirm(){ confirmPop.classList.add('show'); }
function hideConfirm(){ confirmPop.classList.remove('show'); }

if (btnConfirmarSolicitar) btnConfirmarSolicitar.addEventListener('click', async (e)=>{
  e.preventDefault();
  if (!validarFormularioSolicitar()) return;
  const nombre = (document.getElementById('nombreSolicitar').value||'').trim();
  const telCode = document.getElementById('telCodeSolicitar').value;
  const telefono = (document.getElementById('telefonoSolicitar').value||'').trim();
  const agencia = (document.getElementById('plataformaSolicitar').value||'').trim();
  const descripcion = (document.getElementById('descripcionSolicitar').value||'').trim() || null;
  const tipo = document.getElementById('tipoEnvioSolicitar').value;
  const peso_aprox = Number(document.getElementById('pesoSolicitar').value);
  const telefonoFull = `${telCode}${telefono}`;
  const payload = { nombre, telefono: telefonoFull, agencia, descripcion, tipo, peso_aprox };

  showWaiting();
  btnConfirmarSolicitar.disabled = true;

  try {
    const resp = await fetch(`${API_BASE}/pedidos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(()=>null);
      waitingError.style.display = 'block';
      waitingError.textContent = `Error guardando la solicitud (${resp.status})`;
      console.error('POST /pedidos failed', resp.status, txt);
      btnConfirmarSolicitar.disabled = false;
      return;
    }

    const data = await resp.json().catch(()=>null);
    hideWaiting();
    showConfirm();

    document.getElementById('nombreSolicitar').value = '';
    document.getElementById('telCodeSolicitar').value = '+505';
    document.getElementById('telefonoSolicitar').value = '';
    document.getElementById('plataformaSolicitar').value = '';
    document.getElementById('descripcionSolicitar').value = '';
    document.getElementById('tipoEnvioSolicitar').value = 'aereo';
    document.getElementById('pesoSolicitar').value = '';
    reciboSolicitar.style.display = 'none';
    btnConfirmarSolicitar.style.display = 'none';
    btnConfirmarSolicitar.disabled = false;
    btnCalcularSolicitar.style.display = 'block';
  } catch (err) {
    console.error('Error POST /pedidos', err);
    waitingError.style.display = 'block';
    waitingError.textContent = 'Ocurrió un error de red. Intenta nuevamente.';
    btnConfirmarSolicitar.disabled = false;
  }
});

if (btnCerrarConfirm) btnCerrarConfirm.addEventListener('click', (e)=>{
  e.preventDefault();
  hideConfirm();
});

/* End SOLICITAR logic */

</script>
</body>
</html>
