<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Panel del Operador</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root {
  --color-bg: #E8F0F5;
  --color-accent: #2F528F;
  --color-light: #FFFFFF;
  --color-gray: #F6F8FB;
  --color-text-dark: #1A1A1A;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--color-bg);
  color: var(--color-text-dark);
  padding: 1rem;
  max-width: 500px;
  margin: auto;
}

/* --------- NAV/SECCIONES ORIGINALES --------- */
header { text-align: center; margin-bottom: 2rem; }
h1 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; color: var(--color-accent); }
nav { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
nav button { flex: 1; background: var(--color-accent); color: white; border: none; padding: 0.75rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
nav button.inactive { background: #a0b6e0; }

section { background: var(--color-light); padding: 1.5rem; border-radius: 12px; margin-top: 1rem; display: none; }
section.active { display: block; }

label { display: block; margin: 1rem 0 0.5rem; font-weight: 600; }
input, select, textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
input::placeholder { color: #9aa3ad; }
textarea { resize: vertical; }

button.action-btn { margin-top: 1rem; background: var(--color-accent); color: white; border: none; padding: 0.75rem; font-size: 1rem; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }

.recordatorio-item {
  background: var(--color-gray);
  padding: 0.75rem;
  border-radius: 16px;
  margin-bottom: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  overflow: hidden;
}

.recordatorio-info {
  flex: 1;
  border-radius: 12px;
  padding: 0.4rem;
}
.btnEliminar { 
  background: #f56565; 
  color: white; 
  border: none; 
  padding: 0.35rem 0.6rem;
  border-radius: 12px;
  font-size: 0.75rem;
  cursor: pointer; 
  transition: background 0.2s ease;
}
.btnEliminar:hover { background: #ff6b6b; }

/* Pop-ups (tus existentes) */
.popUp, .confirmPop { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-light); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; }
.popUp button, .confirmPop button { margin-top: 0.5rem; width: 100%; }

/* Animación parpadeo */
@keyframes parpadeo {
  0% { background-color: var(--color-light); color: var(--color-text-dark); transform: scale(1); }
  25% { background-color: #e0f0ff; color: var(--color-accent); transform: scale(1.02); }
  50% { background-color: var(--color-accent); color: #fff; transform: scale(1.05); }
  75% { background-color: #e0f0ff; color: var(--color-accent); transform: scale(1.02); }
  100% { background-color: var(--color-light); color: var(--color-text-dark); transform: scale(1); }
}

/* Tooltips */
.form-group { position: relative; }
.tooltip { display: none; position: absolute; left: 0; top: -2rem; background: var(--color-light); color: var(--color-text-dark); padding: 0.35rem 0.55rem; border-radius: 6px; font-size: 0.8rem; white-space: normal; max-width: 95%; box-shadow: 0 4px 12px rgba(0,0,0,0.12); border: 1px solid #ccc; }
.form-group:focus-within .tooltip { display: block; }

/* Teléfono */
.phone-row { display: flex; gap: 0.5rem; align-items: center; }
.phone-row select { width: 35%; min-width: 110px; }
.phone-row input { flex: 1; }

/* Mensajes */
.mensaje { margin-top: 1rem; font-size: 0.95rem; padding: 0.75rem; border-radius: 8px; text-align: center; background: #FFF4CC; color: #665c00; border: 1px solid #FFE08A; }

/* Footer */
footer { color: #888; text-align: center; padding: 0.8rem 0.5rem; font-size: 0.8rem; margin-top: 1.5rem; }

/* Optimización pop-up móviles (tus existentes) */
@media (max-width: 600px) {
  .popUp {
    width: 90%;
    max-width: 400px;
    padding: 1.5rem;
    border-radius: 16px;
  }
  .popUp form input,
  .popUp form textarea,
  .popUp form select,
  .popUp button { font-size: 1rem; }
  .popUp form label { font-size: 0.95rem; }
  .popUp form textarea { min-height: 80px; }
}

/* --------- NUEVOS: OVERLAYS DE CONTRASEÑA --------- */
.authOverlay {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 10000;
}
.authBox {
  background: var(--color-light);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  padding: 1.25rem;
  width: 92%;
  max-width: 340px;
  text-align: center;
}
.authBox h2 { color: var(--color-accent); font-size: 1.2rem; margin-bottom: 0.75rem; }
.authBox input {
  width: 100%; padding: 0.65rem; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 0.75rem;
}
.authBox .btn {
  width: 100%; padding: 0.65rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
  background: var(--color-accent); color: #fff;
}
.authBox .btn.secondary { background: #888; }
.authError { color: #e53935; font-size: 0.9rem; display: none; margin-top: 0.25rem; }

/* contenedor estadísticas */
#estadisticas-container { margin-top: 0.75rem; }
#estadisticasFrame {
  width: 100%;
  min-height: 70vh;
  border: 0;
  border-radius: 12px;
  background: #fff;
}
  /* --- Contenedor de estadísticas --- */
.stats-container {
  width: 100%;
  max-width: 100%;
  background: rgba(255, 255, 255, 0.05);
  padding: 15px;
  border-radius: 10px;
  box-sizing: border-box;
  margin: 0 auto;
}

/* Contenido interno */
.stats-container .stats-content {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Ajustes para pantallas grandes */
@media (min-width: 768px) {
  .stats-container .stats-content {
    flex-direction: row;
    justify-content: space-between;
  }
}

/* Fondo del lightbox con blur */
.lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

/* Oculto por defecto */
.hidden {
  display: none;
}

/* Caja del lightbox */
.lightbox-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 400px;       /* ancho máximo */
  width: 90%;              /* ancho relativo a la pantalla */
  max-height: 70vh;        /* altura máxima: 70% de la ventana */
  overflow-y: auto;        /* scroll vertical si el contenido es largo */
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  text-align: center;
  position: relative;
}

/* Asegura que los párrafos respeten saltos de línea y no se corten */
.lightbox-content p {
  white-space: pre-wrap;   /* respeta saltos de línea */
  word-wrap: break-word;   /* corta palabras largas si es necesario */
}

/* Botón cerrar (similar al sitio) */
.close-lightbox {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

/* Botón eliminar */
.btn-eliminar {
  margin-top: 20px;
  padding: 10px 15px;
  border: none;
  background: #e74c3c;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.btn-eliminar:hover {
  background: #c0392b;
}

/* --- Spinner overlay y pop result (nuevo) --- */
.overlay-spinner {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.28);
  z-index: 11000;
  backdrop-filter: blur(3px);
}
.spinner-box {
  background: var(--color-light);
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  min-width: 220px;
}
.spinner {
  width: 40px; height: 40px;
  margin: 0 auto 10px auto;
  border-radius: 50%;
  border: 4px solid rgba(47,82,143,0.15);
  border-top-color: var(--color-accent);
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.pop-result {
  display: none;
  position: fixed;
  z-index: 12000;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  background: var(--color-light);
  padding: 14px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 360px;
  text-align: center;
}
.pop-result .title { font-weight: 700; color: var(--color-accent); margin-bottom: 8px; }
.pop-result .msg { margin-bottom: 10px; }
.pop-result .btn-close { background: var(--color-accent); color: white; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; width: 100%; }
</style>
</head>
<body>

<div id="app"><!-- wrapper para blur si hiciera falta -->

<header>
<h1>Panel del Operador</h1>
<nav>
<button id="btnInicio">Inicio</button>
<button id="btnAgregar" class="inactive">Agregar Paquete</button>
<button id="btnActualizar" class="inactive">Actualizar Seguimiento</button>
<button id="btnEstadisticas" class="inactive">Estadísticas</button>
</nav>
</header>

<!-- Inicio: Recordatorios -->
<section id="inicio" class="active">
<h2>Inicio</h2>
<div id="listaRecordatorios">
  <p>No hay recordatorios por el momento.</p>
</div>
<button id="btnAgregarRecord" class="action-btn">Agregar Recordatorio</button>

<!-- Pop-up Formulario -->
<div class="popUp" id="popFormRecord">
<h3>Agregar Recordatorio</h3>
<form id="formRecord">
  <label for="tituloRecord">Título del recordatorio</label>
  <input type="text" id="tituloRecord" placeholder="Ej: Llamada importante" required>
  <label for="descRecord">Descripción</label>
  <textarea id="descRecord" rows="2" placeholder="Ej: Llamar a cliente, enviar factura..." required></textarea>
  <label for="fechaRecord">Fecha límite</label>
  <input type="date" id="fechaRecord" required>
  <button type="submit" class="action-btn">Agregar</button>
  <button type="button" id="cerrarPopForm" class="action-btn" style="background:#888;">Cancelar</button>
</form>
</div>

<!-- Pop-up Confirmación Agregado -->
<div class="confirmPop" id="popConfirm">
<p>Recordatorio agregado</p>
<button id="cerrarPopConfirm" class="action-btn">Cerrar</button>
</div>

<!-- Pop-up Confirmación Eliminar (reutilizable) -->
<div class="confirmPop" id="popEliminarConfirm">
<p>¿Desea eliminar este recordatorio?</p>
<button id="btnConfirmEliminar" class="action-btn" style="background:#f56565;">Eliminar</button>
<button id="btnCancelarEliminar" class="action-btn" style="background:#888;">Cancelar</button>
</div>
</section>

<!-- Agregar Paquete -->
<section id="agregar">
<h2>Registrar Paquete</h2>
<form id="formAgregar">
  <div class="form-group">
    <label for="nombre">Nombre del cliente</label>
    <div class="tooltip">Ingresa un nombre y un apellido</div>
    <input type="text" id="nombre" name="nombre" placeholder="Ej: Lester Gamez" required>
  </div>

  <!-- Nuevo campo opcional de código de seguimiento -->
  <div class="form-group">
    <label for="codigo">Código de seguimiento (opcional, max 10 dígitos)</label>
    <input type="text" id="codigo" name="codigo" maxlength="10" pattern="\d{0,10}" placeholder="Solo números">
  </div>

  <div class="form-group">
    <label for="telefonoDigits">Teléfono</label>
    <div class="tooltip">Selecciona (505) o (1) y luego ingresa de 8 a 10 dígitos</div>
    <div class="phone-row">
      <select id="telCode" name="telCode" required>
        <option value="(505)">(505)</option>
        <option value="(1)">(1)</option>
      </select>
      <input type="tel" id="telefonoDigits" name="telefonoDigits" placeholder="Ej: 12345678"
             inputmode="numeric" pattern="[0-9]{8,10}" title="Ingresa solo números (8 a 10 dígitos)" required>
    </div>
  </div>

  <div class="form-group">
    <label for="tipo">Tipo de envío</label>
    <select id="tipo" name="tipo" required>
      <option value="aereo">Aéreo</option>
      <option value="maritimo">Marítimo</option>
    </select>
  </div>

  <button type="submit" class="action-btn">Registrar Paquete</button>
</form>
<div id="mensajeAgregar" class="mensaje" style="display:none;">
Esta plataforma es de prueba, dog. Acción no disponible por el momento.
</div>
</section>

<!-- Actualizar Seguimiento -->
<section id="actualizar">
<h2>Actualizar Estado</h2>
<form id="formActualizar">
  <div class="form-group">
    <label for="nombreSeg">Nombre del cliente</label>
    <div class="tooltip">Ingresa un nombre y un apellido</div>
    <input type="text" id="nombreSeg" name="nombreSeg" placeholder="Ej: Lester Gamez">
  </div>

  <!-- Nuevo campo opcional de código de seguimiento -->
 <div class="form-group">
    <label for="codigoSeg">Código de seguimiento (obligatorio, max 10 dígitos)</label>
    <input type="text" id="codigoSeg" name="codigoSeg" maxlength="10" pattern="\d{1,10}" placeholder="Solo números" required>
  </div>

  <div class="form-group">
    <label for="telefonoSegDigits">Teléfono</label>
    <div class="tooltip">Selecciona (505) o (1) y luego ingresa de 8 a 10 dígitos</div>
    <div class="phone-row">
      <select id="telCodeSeg" name="telCodeSeg">
        <option value="(505)">(505)</option>
        <option value="(1)">(1)</option>
      </select>
      <input type="tel" id="telefonoSegDigits" name="telefonoSegDigits" placeholder="Ej: 12345678"
             inputmode="numeric" pattern="[0-9]{8,10}" title="Ingresa solo números (8 a 10 dígitos)">
    </div>
  </div>

  <div class="form-group">
    <label for="estado">Estado del paquete</label>
    <select id="estadoSeg" name="estado">
      <option value="">-- Seleccione --</option>
      <option value="recibido">Recibido</option>
      <option value="en_transito">En tránsito</option>
      <option value="en_aduana">En Aduana</option>
      <option value="listo_recoger">Listo Para Recoger</option>
    </select>
  </div>

  <div class="form-group">
    <label for="pesoSeg">Peso en libras</label>
    <input type="number" id="pesoSeg" name="pesoSeg" step="0.1" min="0" placeholder="Ej: 1.0">
  </div>
  <div class="form-group">
  <label for="tarifaSeg">Tarifa en USD</label>
  <input type="number" id="tarifaSeg" name="tarifaSeg" step="0.1" min="0" placeholder="Ej: 1.1">
</div>


  <div class="form-group">
    <label for="fechaEstado">Ingrese fecha</label>
    <input type="date" id="fechaEstado" name="fechaEstado">
  </div>

  <button type="submit" class="action-btn">Actualizar Estado</button>
</form>
<div id="mensajeActualizar" class="mensaje" style="display:none;">
Esta plataforma es de prueba, dog. Acción no disponible por el momento.
</div>
</section>


<!-- ESTADÍSTICAS (Nueva sección) -->
<section id="estadisticas">
  <div id="estadisticas-container">
    <iframe id="estadisticasFrame" src="" title="Estadísticas"></iframe>
  </div>
</section>

<footer>
&copy; 2025. Irvin Prado. Ascende Superius - Seek Higher Things
</footer>

</div><!-- /#app -->

<!-- OVERLAY: LOCK INICIAL -->
<div id="lockOverlay" class="authOverlay">
  <div class="authBox">
    <h2>Acceso al Panel</h2>
    <input type="password" id="lockPass" placeholder="Contraseña">
    <button class="btn" id="lockSubmit">Entrar</button>
    <div class="authError" id="lockError">Contraseña incorrecta</div>
  </div>
</div>

<!-- OVERLAY: ESTADÍSTICAS -->
<div id="statsOverlay" class="authOverlay" style="display:none;">
  <div class="authBox">
    <h2>Acceso a Estadísticas</h2>
    <input type="password" id="statsPass" placeholder="Contraseña">
    <button class="btn" id="statsSubmit">Acceder</button>
    <button class="btn secondary" id="statsCancel" style="margin-top:0.5rem;">Cancelar</button>
    <div class="authError" id="statsError">Contraseña incorrecta</div>
  </div>
</div>

<!-- Lightbox Recordatorio -->
<div id="lightbox-recordatorio" class="lightbox hidden">
  <div class="lightbox-content">
    <button class="close-lightbox">&times;</button>
    <h2>Recordatorio</h2>
    <p>Versión de prueba, datos no disponibles</p>
    <button class="btn-eliminar">Eliminar recordatorio</button>
  </div>
</div>

<!-- Spinner overlay -->
<div id="overlaySpinner" class="overlay-spinner">
  <div class="spinner-box">
    <div class="spinner"></div>
    <div>Realizando operación, espera...</div>
  </div>
</div>

<!-- Resultado -->
<div id="popResult" class="pop-result" role="dialog" aria-modal="true">
  <div class="title" id="popResultTitle">Operación</div>
  <div class="msg" id="popResultMsg">Mensaje</div>
  <button id="popResultClose" class="btn-close">Cerrar</button>
</div>

<script>
/*
  Integración fetch ajustada al back end que mostraste.
  - Asegúrate de que API_BASE apunte a tu deployment.
  - POST /paquetes espera: nombre_cliente, codigo_seguimiento, telefono, tipo_envio_id, peso_libras, tarifa_usd, fecha_estado
  - PUT  /paquetes/:identifier espera: peso_libras, tarifa_usd, fecha_estado (y opcionalmente estado)
  - POST /recordatorios espera: titulo, descripcion, fecha_limite
*/

const API_BASE = 'https://nicaexpressway.onrender.com'; // <- ajusta si es necesario

// ================== Helpers DOM ==================
function $(id){ return document.getElementById(id); }
function getValOrNull(id){
  const el = $(id);
  if(!el) return null;
  const v = (el.value ?? '').toString().trim();
  return v === '' ? null : v;
}
function getNumberOrNull(id){
  const v = getValOrNull(id);
  if (v === null) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

// ================== NAVEGACIÓN (igual que antes) ==================
const btnInicio = $('btnInicio');
const btnAgregar = $('btnAgregar');
const btnActualizar = $('btnActualizar');
const btnEstadisticas = $('btnEstadisticas');

const secciones = {
  inicio: $('inicio'),
  agregar: $('agregar'),
  actualizar: $('actualizar'),
  estadisticas: $('estadisticas')
};

function mostrarSeccion(nombre){
  for(let sec in secciones) if(secciones[sec]) secciones[sec].classList.remove('active');
  if(secciones[nombre]) secciones[nombre].classList.add('active');

  [btnInicio, btnAgregar, btnActualizar, btnEstadisticas].forEach(b => { if(b) b.classList.add('inactive'); });
  if(nombre==='inicio' && btnInicio) btnInicio.classList.remove('inactive');
  if(nombre==='agregar' && btnAgregar) btnAgregar.classList.remove('inactive');
  if(nombre==='actualizar' && btnActualizar) btnActualizar.classList.remove('inactive');
  if(nombre==='estadisticas' && btnEstadisticas) btnEstadisticas.classList.remove('inactive');
}
if(btnInicio) btnInicio.addEventListener('click',()=>mostrarSeccion('inicio'));
if(btnAgregar) btnAgregar.addEventListener('click',()=>mostrarSeccion('agregar'));
if(btnActualizar) btnActualizar.addEventListener('click',()=>mostrarSeccion('actualizar'));
if(btnEstadisticas) btnEstadisticas.addEventListener('click',()=>{
  const so = $('statsOverlay');
  if(so) so.style.display = 'flex';
});

// ================== FECHA ACTUAL PRESELECCIONADA ==================
const fechaEstadoDefault = new Date().toISOString().split('T')[0];
if ($('fechaEstado')) $('fechaEstado').value = fechaEstadoDefault;
if ($('fechaRecord')) $('fechaRecord').value = fechaEstadoDefault;
if ($('fecha')) { /* reservado si tu formulario usa id 'fecha' */ }

// ================== SPINNER / POP RESULT ==================
const overlaySpinner = $('overlaySpinner');
const popResult = $('popResult');
const popResultTitle = $('popResultTitle');
const popResultMsg = $('popResultMsg');
const popResultClose = $('popResultClose');

function showSpinner(){ if(overlaySpinner){ overlaySpinner.style.display = 'flex'; } if(window.appWrapper) appWrapper.style.filter = 'blur(3px)'; }
function hideSpinner(){ if(overlaySpinner){ overlaySpinner.style.display = 'none'; } if(window.appWrapper) appWrapper.style.filter = ''; }

function showResult(title, msg){
  if(popResultTitle) popResultTitle.textContent = title;
  if(popResultMsg) popResultMsg.textContent = msg;
  if(popResult) popResult.style.display = 'block';
}
if(popResultClose) popResultClose.addEventListener('click', ()=>{ if(popResult) popResult.style.display = 'none'; });

// ================== FORMULARIOS ==================
const formAgregar = $('formAgregar');
const formActualizar = $('formActualizar');

// map tipo string -> id según tu tabla tipos_envio (1=aereo,2=maritimo)
function mapTipoToId(tipoStr){
  // acepta 'aereo'|'maritimo' o '1'|'2'
  if (tipoStr === '1' || tipoStr === 1) return 1;
  if (tipoStr === '2' || tipoStr === 2) return 2;
  return tipoStr === 'aereo' ? 1 : (tipoStr === 'maritimo' ? 2 : null);
}

// ---------- AGREGAR PAQUETE (POST) ----------
if (formAgregar) {
  formAgregar.addEventListener('submit', async function(e){
    e.preventDefault();

    // Leer campos (si tu HTML tiene estos ids)
    const nombre = getValOrNull('nombre');
    const codigo = getValOrNull('codigo');
    const telCode = getValOrNull('telCode') || ''; // ejemplo: +505
    const telefonoDigits = getValOrNull('telefonoDigits') || getValOrNull('telefono'); // si tienes 'telefono' simple
    const telefono = telefonoDigits ? `${telCode}${telefonoDigits}` : null;
    const tipoSel = getValOrNull('tipo'); // ejemplo: 'aereo' or 'maritimo' or '1'/'2'
    const tipo_envio_id = mapTipoToId(tipoSel);

    // Opcionales: peso, tarifa, fecha_estado (si tus inputs existen)
    const peso_libras = getNumberOrNull('peso') ?? getNumberOrNull('peso_libras');
    const tarifa_usd = getNumberOrNull('tarifa') ?? getNumberOrNull('tarifa_usd');
    const fecha_estado = getValOrNull('fechaEstadoAgregar') ?? getValOrNull('fecha_estado') ?? null;

    const payload = {
      nombre_cliente: nombre || null,
      codigo_seguimiento: codigo || null,
      telefono: telefono || null,
      tipo_envio_id: tipo_envio_id ?? null,
      // sólo agregar los opcionales si no son null (para mantener request limpio)
    };

    if (peso_libras !== null) payload.peso_libras = peso_libras;
    if (tarifa_usd !== null) payload.tarifa_usd = tarifa_usd;
    if (fecha_estado !== null) payload.fecha_estado = fecha_estado;

    showSpinner();
    try {
      const res = await fetch(`${API_BASE}/paquetes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let errText = `Error ${res.status}`;
        try { const errJson = await res.json(); if(errJson?.error) errText = errJson.error; } catch(_) {}
        throw new Error(errText);
      }

      // éxito
      hideSpinner();
      showResult('Operación realizada', 'Paquete registrado correctamente.');
      formAgregar.reset();
      // volver a preseleccionar la fecha actual si había campo
      if ($('fechaEstado')) $('fechaEstado').value = fechaEstadoDefault;
    } catch(err){
      hideSpinner();
      console.error('Agregar paquete error:', err);
      showResult('Error', 'No se pudo registrar el paquete. Revisa la consola o intenta más tarde.');
    }
  });
}

// ---------- ACTUALIZAR SEGUIMIENTO (PUT /paquetes/:identifier) ----------
if (formActualizar) {
  formActualizar.addEventListener('submit', async function(e){
    e.preventDefault();

    // identifier (puede ser código de seguimiento o id numérico)
    const identifier = getValOrNull('codigoSeg');
    if (!identifier) { showResult('Error', 'Debe ingresar el código o ID del paquete.'); return; }

    // Campos opcionales a actualizar
    const pesoRaw = getValOrNull('pesoSeg');        // input id: pesoSeg
    const tarifaRaw = getValOrNull('tarifaSeg');    // input id: tarifaSeg
    const fecha_estado = getValOrNull('fechaEstado') || null; // input id: fechaEstado
    const estado = getValOrNull('estadoSeg') || null; // si quieres mandar estado para historial (opcional)

    // Construir updateObj según espera tu backend (peso_libras, tarifa_usd, fecha_estado, estado)
    const updateObj = {};
    if (pesoRaw !== null) {
      const p = Number(pesoRaw);
      if (!Number.isNaN(p)) updateObj.peso_libras = p;
    }
    if (tarifaRaw !== null) {
      const t = Number(tarifaRaw);
      if (!Number.isNaN(t)) updateObj.tarifa_usd = t;
    }
    if (fecha_estado !== null) updateObj.fecha_estado = fecha_estado;
    if (estado !== null) updateObj.estado = estado; // backend añadirá a historial si viene estado + fecha_estado

    if (Object.keys(updateObj).length === 0){
      showResult('Aviso', 'No hay campos para actualizar.');
      return;
    }

    showSpinner();
    try {
      // Usamos PUT con identifier en la URL (backend soporta id numérico o codigo_seguimiento)
      const res = await fetch(`${API_BASE}/paquetes/${encodeURIComponent(identifier)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateObj)
      });

      if (!res.ok) {
        let errText = `Actualizar fallo ${res.status}`;
        try {
          const errJson = await res.json();
          if (errJson?.error) errText = errJson.error;
        } catch (_) {}
        throw new Error(errText);
      }

      const result = await res.json();
      // backend devuelve array con filas actualizadas
      const data = Array.isArray(result) ? result : (result?.data ?? result);

      if (!data || (Array.isArray(data) && data.length === 0)) {
        hideSpinner();
        showResult('No encontrado', 'No se encontró paquete con ese identificador o no se realizaron cambios.');
        return;
      }

      hideSpinner();
      showResult('Operación realizada', 'Estado del paquete actualizado.');
      formActualizar.reset();
      if ($('fechaEstado')) $('fechaEstado').value = fechaEstadoDefault;
    } catch(err){
      hideSpinner();
      console.error('Actualizar seguimiento error:', err);
      showResult('Error', `No fue posible actualizar el paquete. ${err.message || ''}`);
    }
  });
}

// ================== RECORDATORIOS ==================
const listDiv = $('listaRecordatorios');
const formR = $('formRecord');
const popForm = $('popFormRecord');
const popConfirm = $('popConfirm');
const popEliminarConfirm = $('popEliminarConfirm');
const btnAgregarRecord = $('btnAgregarRecord');
const cerrarPopForm = $('cerrarPopForm');
const cerrarPopConfirm = $('cerrarPopConfirm');
const btnConfirmEliminar = $('btnConfirmEliminar');
const btnCancelarEliminar = $('btnCancelarEliminar');
const fechaInput = $('fechaRecord');
let indexEliminar = null;

if (fechaInput) fechaInput.value = fechaEstadoDefault;

async function cargarRecord(){
  if (!listDiv) return;
  listDiv.innerHTML = '<p>Cargando recordatorios...</p>';
  try {
    const res = await fetch(`${API_BASE}/recordatorios`);
    if (!res.ok) throw new Error(`fetch ${res.status}`);
    const arr = await res.json();
    renderRecordList(arr);
  } catch(err){
    console.warn('Fallo al cargar recordatorios desde API, usando localStorage', err);
    const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
    const mapped = arr.map((r, idx) => ({ id: `local-${idx}`, titulo: r.titulo, descripcion: r.desc || r.descripcion, fecha_limite: r.fecha || r.fecha }));
    renderRecordList(mapped);
  }
}

function renderRecordList(arr){
  if (!listDiv) return;
  const hoy = new Date().toISOString().split('T')[0];
  listDiv.innerHTML = '';
  const activos = (arr||[]).filter(r => !r.fecha_limite || r.fecha_limite >= hoy);
  if (!activos.length){ listDiv.innerHTML = '<p>No hay recordatorios por el momento.</p>'; return; }
  activos.forEach((r, index) => {
    const div = document.createElement('div');
    div.classList.add('recordatorio-item');
    div.dataset.id = r.id ?? `local-${index}`;
    div.innerHTML = `
      <div class="recordatorio-info"><strong>${r.titulo || ''}</strong><br>${r.descripcion || r.desc || ''}<br><small>${r.fecha_limite || r.fecha || ''}</small></div>
      <button class="btnEliminar" data-id="${r.id ?? `local-${index}`}">X</button>`;
    listDiv.appendChild(div);
    if ((r.fecha_limite || r.fecha) === hoy){ div.querySelector('.recordatorio-info').style.animation = "parpadeo 1.2s infinite"; }
  });
}

// abrir/ cerrar form
if (btnAgregarRecord) btnAgregarRecord.addEventListener('click', ()=>{ if(popForm) popForm.style.display='block'; });
if (cerrarPopForm) cerrarPopForm.addEventListener('click', ()=>{ if(popForm) popForm.style.display='none'; });

// submit agregar record (POST)
if (formR) {
  formR.addEventListener('submit', async (e) => {
    e.preventDefault();
    const titulo = getValOrNull('tituloRecord');
    const desc = getValOrNull('descRecord');
    const fecha = getValOrNull('fechaRecord');

    const payload = { titulo: titulo || null, descripcion: desc || null, fecha_limite: fecha || null };

    showSpinner();
    try {
      const res = await fetch(`${API_BASE}/recordatorios`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`POST record ${res.status}`);
      hideSpinner();
      if(popForm) popForm.style.display = 'none';
      showResult('Registro', 'Recordatorio agregado.');
      await cargarRecord();
      formR.reset(); if(fechaInput) fechaInput.value = fechaEstadoDefault;
    } catch(err){
      hideSpinner();
      console.warn('Agregar record falló, guardando en localStorage', err);
      const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
      arr.push({ titulo, desc, fecha });
      localStorage.setItem('recordatorios', JSON.stringify(arr));
      if(popForm) popForm.style.display = 'none';
      if(popConfirm) popConfirm.style.display = 'block';
      cargarRecord();
    }
  });
}
if (cerrarPopConfirm) cerrarPopConfirm.addEventListener('click', ()=>{ if(popConfirm) popConfirm.style.display = 'none'; });

// Delegación: botones X (eliminar) y click item (lightbox)
const lightbox = $('lightbox-recordatorio');
const closeBtn = document.querySelector('.close-lightbox');
const lbDelete = document.querySelector('#lightbox-recordatorio .btn-eliminar');
let indexSeleccionado = null;

if(listDiv) {
  listDiv.addEventListener('click', (e) => {
    const eliminarBtn = e.target.closest('.btnEliminar');
    if (eliminarBtn) {
      indexEliminar = eliminarBtn.dataset.id;
      if(popEliminarConfirm) popEliminarConfirm.style.display = 'block';
      return;
    }

    const item = e.target.closest('.recordatorio-item');
    if (item) {
      indexSeleccionado = item.dataset.id;
      (async () => {
        try {
          if (String(indexSeleccionado).startsWith('local-')) {
            const arrLocal = JSON.parse(localStorage.getItem('recordatorios')||'[]');
            const idx = Number(indexSeleccionado.replace('local-',''));
            const r = arrLocal[idx] || {};
            fillLightbox(r.titulo, r.desc, r.fecha);
          } else {
            const res = await fetch(`${API_BASE}/recordatorios/${encodeURIComponent(indexSeleccionado)}`);
            if (!res.ok) throw new Error('no fetch lb');
            const r = await res.json();
            fillLightbox(r.titulo || r.titulo, r.descripcion || r.desc, r.fecha_limite || r.fecha);
          }
        } catch(err){
          const title = item.querySelector('.recordatorio-info strong')?.textContent || 'Recordatorio';
          const small = item.querySelector('.recordatorio-info small')?.textContent || '';
          const descText = item.querySelector('.recordatorio-info')?.childNodes[2]?.textContent || '';
          fillLightbox(title, descText, small);
        }
        if(lightbox) lightbox.classList.remove('hidden');
      })();
    }
  });
}

function fillLightbox(titulo, desc, fecha){
  if(!lightbox) return;
  const titleEl = lightbox.querySelector('h2');
  const pEl = lightbox.querySelector('p');
  if(titleEl) titleEl.textContent = titulo || 'Recordatorio';
  if(pEl) pEl.innerHTML = `${desc || ''}${(desc && fecha)?'<br>':''}<small>${fecha || ''}</small>`;
}

if(closeBtn) closeBtn.addEventListener('click', () => { if(lightbox) lightbox.classList.add('hidden'); });
if(lightbox) lightbox.addEventListener('click', (e) => { if (e.target === lightbox) lightbox.classList.add('hidden'); });

if(lbDelete) lbDelete.addEventListener('click', () => {
  if (indexSeleccionado != null) {
    if(popEliminarConfirm) popEliminarConfirm.style.display = 'block';
    if(lightbox) lightbox.classList.add('hidden');
    indexEliminar = indexSeleccionado;
  }
});

// confirmar eliminación (popEliminarConfirm)
if (btnConfirmEliminar) {
  btnConfirmEliminar.addEventListener('click', async () => {
    if (!indexEliminar) { if(popEliminarConfirm) popEliminarConfirm.style.display='none'; return; }

    showSpinner();
    try {
      if (String(indexEliminar).startsWith('local-')) {
        const idx = Number(indexEliminar.replace('local-',''));
        const arr = JSON.parse(localStorage.getItem('recordatorios')||'[]');
        arr.splice(idx,1);
        localStorage.setItem('recordatorios', JSON.stringify(arr));
        hideSpinner();
        if(popEliminarConfirm) popEliminarConfirm.style.display='none';
        cargarRecord();
        showResult('Eliminado', 'Recordatorio eliminado (local).');
        indexEliminar = null;
        return;
      }

      const res = await fetch(`${API_BASE}/recordatorios/${encodeURIComponent(indexEliminar)}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`Delete failed ${res.status}`);
      hideSpinner();
      if(popEliminarConfirm) popEliminarConfirm.style.display='none';
      showResult('Eliminado', 'Recordatorio eliminado.');
      indexEliminar = null;
      await cargarRecord();
    } catch(err){
      hideSpinner();
      if(popEliminarConfirm) popEliminarConfirm.style.display='none';
      console.error('Eliminar record error', err);
      showResult('Error', 'No se pudo eliminar. Intenta más tarde.');
    }
  });
}
if (btnCancelarEliminar) btnCancelarEliminar.addEventListener('click', ()=>{ if(popEliminarConfirm) popEliminarConfirm.style.display='none'; indexEliminar=null; });

// ================== LOCKS / STATS (igual que antes, con checks) ==================
const PASS_LOCK  = "12345678";
const PASS_STATS = "12345678";

const appWrapper   = $('app');
const lockOverlay  = $('lockOverlay');
const statsOverlay = $('statsOverlay');

const lockPass   = $('lockPass');
const lockSubmit = $('lockSubmit');
const lockError  = $('lockError');

const statsPass    = $('statsPass');
const statsSubmit  = $('statsSubmit');
const statsCancel  = $('statsCancel');
const statsError   = $('statsError');

const statsFrame   = $('estadisticasFrame');

if(appWrapper) appWrapper.style.filter = 'blur(6px)';

function tryUnlock(){
  if(!lockPass) return;
  if (lockPass.value === PASS_LOCK){
    if(lockError) lockError.style.display = 'none';
    if(lockOverlay) lockOverlay.style.display = 'none';
    if(appWrapper) appWrapper.style.filter = 'none';
    lockPass.value = '';
    cargarRecord();
  } else {
    if(lockError) lockError.style.display = 'block';
  }
}
if(lockSubmit) lockSubmit.addEventListener('click', tryUnlock);
if(lockPass) lockPass.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryUnlock(); });

function openStats(){
  if(!statsOverlay) return;
  statsOverlay.style.display = 'flex';
  if(statsError) statsError.style.display = 'none';
  if(statsPass) { statsPass.value = ''; statsPass.focus(); }
}
function closeStats(){
  if(statsOverlay) statsOverlay.style.display = 'none';
}
function loadStatsIfAuthorized(){
  if(!statsPass) return;
  if (statsPass.value === PASS_STATS){
    if(statsError) statsError.style.display = 'none';
    closeStats();
    if (statsFrame && statsFrame.src !== 'https://irvinforbusinesses.github.io/Nicaexpressway/estadisticas.html'){
      statsFrame.src = 'https://irvinforbusinesses.github.io/Nicaexpressway/estadisticas.html';
    }
    mostrarSeccion('estadisticas');
    statsPass.value = '';
  } else {
    if(statsError) statsError.style.display = 'block';
  }
}
if(statsSubmit) statsSubmit.addEventListener('click', loadStatsIfAuthorized);
if(statsPass) statsPass.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') loadStatsIfAuthorized(); });
if(statsCancel) statsCancel.addEventListener('click', closeStats);

// ================== Inicial ==================
/* No cargamos recordatorios hasta que el panel esté desbloqueado; el unlock llamará a cargarRecord() */
</script>
</body>
</html>
