<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Estadísticas - Nica Expressway (En vivo)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --color-bg:#E8F0F5;
  --color-accent:#2F528F;
  --color-light:#FFFFFF;
  --muted:#888;
  --card-shadow: 0 6px 18px rgba(47,82,143,0.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Inter",sans-serif;background:var(--color-bg);color:#1a1a1a;padding:1.2rem;max-width:980px;margin:auto;padding-bottom:72px;}
h1{font-family:'Poppins',sans-serif;color:var(--color-accent);margin-bottom:0.75rem}
.filters-container{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1.25rem;flex-wrap:wrap}
.filter-item label{display:block;margin-bottom:0.25rem;font-weight:600}
.filter-select{padding:0.55rem 0.75rem;border-radius:10px;border:1px solid #d7dbe6;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 2px 6px rgba(47,82,143,0.04);font-weight:600}
.grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.card{background:var(--color-light);border-radius:12px;padding:1rem;box-shadow:var(--card-shadow);min-height:110px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start}
.card-title{font-weight:700;color:#233a66;margin-bottom:0.4rem}
.card-value{font-size:1.45rem;font-weight:800;display:flex;align-items:center;gap:0.6rem}
.pkg-icon{width:28px;height:28px;display:inline-block;vertical-align:middle}
.chart-wrap{background:var(--color-light);border-radius:12px;padding:1rem;box-shadow:var(--card-shadow);margin-top:1rem}
.canvas-holder{width:100%;height:220px;position:relative}
.note{margin-top:1rem;text-align:center;color:var(--muted);font-style:italic}
.loading{background:linear-gradient(90deg,#f4f8ff,#f8fbff);border:1px dashed #dbe7fb;padding:0.8rem;border-radius:10px;color:#234;display:flex;align-items:center;gap:0.6rem;box-shadow:0 2px 6px rgba(47,82,143,0.03)}
/* footer legal */
.site-footer {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  text-align: center;
  color: #888;
  background: rgba(255,255,255,0.9);
  padding: 0.5rem;
  font-size: 0.8rem;
  box-shadow: 0 -1px 6px rgba(0,0,0,0.03);
}

/* responsive */
@media (max-width:520px){.card-value{font-size:1.2rem}.canvas-holder{height:180px}}
</style>
</head>
<body>
  <h1>Estadísticas (En vivo)</h1>

  <div class="filters-container">
    <div class="filter-item">
      <label for="filter-general">Filtrar por:</label>
      <select id="filter-general" class="filter-select" aria-label="Filtro estadisticas">
        <option value="general">Generales</option>
        <option value="maritimo">Marítimo</option>
        <option value="aereo">Aéreo</option>
      </select>
    </div>

    <div style="margin-left:auto;align-self:flex-end">
      <button id="refreshBtn" style="background:var(--color-accent);color:#fff;padding:.55rem .9rem;border-radius:10px;border:none;font-weight:700;cursor:pointer">Actualizar</button>
    </div>
  </div>

  <div id="loading" class="loading" style="display:none;">
    <strong>Extrayendo datos, espera...</strong>
  </div>

  <div class="grid" style="margin-top:1rem">
    <div class="card">
      <div>
        <div class="card-title">Paquetes enviados</div>
        <div id="card-enviados" class="card-value">—</div>
      </div>
    </div>

    <div class="card">
      <div>
        <div class="card-title">Paquetes en bodega</div>
        <div id="card-bodega" class="card-value">—</div>
      </div>
    </div>

    <div class="card">
      <div>
        <div class="card-title">Paquetes camino a Nicaragua</div>
        <div id="card-camino" class="card-value">—</div>
      </div>
    </div>

    <div class="card">
      <div>
        <div class="card-title">Paquetes en aduana</div>
        <div id="card-aduana" class="card-value">—</div>
      </div>
    </div>

    <div class="card" style="grid-column: span 2;">
      <div>
        <div class="card-title">Ganancias (USD)</div>
        <div id="card-ganancias" class="card-value">—</div>
      </div>
    </div>
  </div>

  <div class="chart-wrap" id="chartWrap" style="display:none;margin-top:1rem">
    <h2 style="margin:0 0 0.6rem 0;font-size:1rem;color:var(--color-accent)">Distribución por estado (Pie)</h2>
    <div class="canvas-holder">
      <canvas id="pieCanvas" width="800" height="400" role="img" aria-label="Gráfico de pastel con distribución de paquetes" style="width:100%;height:220px;display:block"></canvas>
    </div>
    <div id="chartLegend" style="display:flex;gap:1rem;margin-top:.6rem;flex-wrap:wrap"></div>
  </div>

  <div class="note">Los conteos se calculan por el estado más reciente en cada fila de <code>historial</code> (estado4..estado1).</div>

  <!-- footer legal -->
  <div class="site-footer">&copy; 2025. Irvin Prado. Ascende Superius - Seek Higher Things</div>

<script>
/* --- CONFIG: ajusta si tu backend está en otro host --- */
const API_BASE = 'https://nicaexpressway.onrender.com'; // sin slash final

/* refs */
const selectFilter = document.getElementById('filter-general');
const refreshBtn = document.getElementById('refreshBtn');
const loading = document.getElementById('loading');

const cardEnviados = document.getElementById('card-enviados');
const cardBodega = document.getElementById('card-bodega');
const cardCamino = document.getElementById('card-camino');
const cardAduana = document.getElementById('card-aduana');
const cardGanancias = document.getElementById('card-ganancias');

const chartWrap = document.getElementById('chartWrap');
const pieCanvas = document.getElementById('pieCanvas');
const chartLegend = document.getElementById('chartLegend');
const ctx = pieCanvas.getContext('2d');

const PIE_COLORS = ['#2F528F','#1f3a66','#79A7E4','#9bbcf3'];

/* small inline SVG generators (no external images) */
/* color argument accepts any CSS color */
function svgMailbox(color){ return `
  <svg class="pkg-icon" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M3 11v8a2 2 0 0 0 2 2h14v-2H5v-6H3z"/><path d="M21 7h-6.5L12 3 9.5 7H3v6h18V7z"/>
  </svg>`; }
function svgWarehouse(color){ return `
  <svg class="pkg-icon" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M12 2L2 7v13a1 1 0 0 0 1 1h6v-7h6v7h6a1 1 0 0 0 1-1V7L12 2z"/><path d="M12 12v8"/></svg>`; }
function svgPlane(color){ return `
  <svg class="pkg-icon" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M21 16v-2l-8-5V3.5a1.5 1.5 0 0 0-3 0V9L2 14v2l8-1.5V21l1 .5 1-.5v-6.5L21 16z"/></svg>`; }
function svgClock(color){ return `
  <svg class="pkg-icon" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 11h4v-2h-3V6h-2v7z"/></svg>`; }

/* fetch stats */
async function fetchStats(filter = 'general'){
  loading.style.display = 'flex';
  try {
    const url = `${API_BASE}/stats?filter=${encodeURIComponent(filter)}`;
    const res = await fetch(url);
    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(`Error ${res.status} ${txt||''}`);
    }
    const json = await res.json();
    loading.style.display = 'none';
    return json;
  } catch (err) {
    loading.style.display = 'none';
    console.error('fetchStats error', err);
    throw err;
  }
}

function formatMoney(v){ return `$${Number(v||0).toFixed(2)}`; }

/* render cards: inject number + inline SVG icons matching meaning */
function renderCards(data){
  const enviados = data.counts.enviados ?? 0;
  const bodega = data.counts.bodega ?? 0;
  const camino = data.counts.camino ?? 0;
  const aduana = data.counts.aduana ?? 0;
  const ganancias = data.ganancias ?? 0;

  // colores del icono para armonizar con el sitio
  const c = 'var(--color-accent)' ; // we will use CSS var — fallback to hex
  // but inline SVG fill must be concrete: use the CSS color value via computed style
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--color-accent') || '#2F528F';

  cardEnviados.innerHTML = `${enviados} ${svgMailbox(accent)}`;
  cardBodega.innerHTML  = `${bodega} ${svgWarehouse(accent)}`;
  cardCamino.innerHTML  = `${camino} ${svgPlane(accent)}`;
  cardAduana.innerHTML  = `${aduana} ${svgClock(accent)}`;
  cardGanancias.textContent = formatMoney(ganancias);
}

/* HIGH DPI / retina scaling for canvas */
function resizeCanvasToDisplaySize(canvas) {
  const ratio = window.devicePixelRatio || 1;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  if (w === 0 || h === 0) return false;
  const needResize = canvas.width !== Math.floor(w * ratio) || canvas.height !== Math.floor(h * ratio);
  if (needResize) {
    canvas.width  = Math.floor(w * ratio);
    canvas.height = Math.floor(h * ratio);
    // scale so drawing uses CSS px coordinates
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }
  return true;
}

/* draw pie based on counts */
function drawPieFromCounts(counts){
  lastCounts = counts; // keep last for resize/redraw
  const enviados = counts.enviados||0;
  const bodega = counts.bodega||0;
  const camino = counts.camino||0;
  const aduana = counts.aduana||0;
  const total = enviados + bodega + camino + aduana;

  if (total === 0) {
    chartWrap.style.display = 'none';
    return;
  }
  chartWrap.style.display = 'block';

  // prepare data segments (only >0)
  const segments = [
    { label: 'Enviados', value: enviados, color: PIE_COLORS[0] },
    { label: 'Bodega', value: bodega, color: PIE_COLORS[2] },
    { label: 'Camino', value: camino, color: PIE_COLORS[1] },
    { label: 'Aduana', value: aduana, color: PIE_COLORS[3] }
  ].filter(s => s.value > 0);

  // ensure canvas has size
  const ok = resizeCanvasToDisplaySize(pieCanvas);
  if (!ok) {
    // fallback: postpone drawing
    setTimeout(()=> drawPieFromCounts(counts), 200);
    return;
  }

  // compute drawing dimensions in CSS pixels
  const w = pieCanvas.clientWidth;
  const h = pieCanvas.clientHeight;
  const cx = w/2;
  const cy = h/2;
  const radius = Math.min(cx, cy) - 10;

  // clear
  ctx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);

  let start = -Math.PI/2;
  chartLegend.innerHTML = '';

  segments.forEach((seg, idx) => {
    const slice = seg.value / total * Math.PI * 2;
    const end = start + slice;

    // draw slice
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, start, end);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();

    // stroke edge
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1;
    ctx.stroke();

    // legend item with percent
    const percent = Math.round((seg.value / total) * 100);
    const leg = document.createElement('div');
    leg.style.display='flex';
    leg.style.alignItems='center';
    leg.style.gap='0.5rem';
    leg.innerHTML = `<div style="width:14px;height:14px;background:${seg.color};border-radius:4px"></div>
                     <div style="font-size:0.95rem">${seg.label}: ${seg.value} (${percent}%)</div>`;
    chartLegend.appendChild(leg);

    start = end;
  });
}

/* main flow */
let lastCounts = null;
async function refreshUI(){
  try {
    const filter = selectFilter.value || 'general';
    loading.style.display = 'flex';
    const data = await fetchStats(filter);
    if(!data || !data.counts) throw new Error('Respuesta inválida del servidor');
    renderCards(data);
    lastCounts = data.counts;
    drawPieFromCounts(lastCounts);
  } catch (e) {
    console.error(e);
    cardEnviados.textContent = '—';
    cardBodega.textContent  = '—';
    cardCamino.textContent  = '—';
    cardAduana.textContent  = '—';
    cardGanancias.textContent = '—';
    chartWrap.style.display = 'none';
    // no alert automático aquí (opcional)
  } finally {
    loading.style.display = 'none';
  }
}

/* events */
selectFilter.addEventListener('change', refreshUI);
refreshBtn.addEventListener('click', refreshUI);
window.addEventListener('resize', ()=>{ if(lastCounts) drawPieFromCounts(lastCounts); });

/* initial */
refreshUI();
</script>
</body>
</html>
